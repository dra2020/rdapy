---
layout: page
title: High-Volume Offline Scoring
permalink: scoring/
---

A command-line interface provides a set of scripts that enable you to "score" large collections of plans in bulk.
This is useful for scoring ensembles of plans, e.g., generated by ReCom.
These scripts are in the `scripts` directory.

## SCORE.sh

The main bash script takes an ensemble of plans and input data and 
generates a CSV file of scores and a JSONL file of by-district measures.

```bash
scripts/SCORE.sh \
--state xx \
--plan-type congress \
--geojson path/to/DRA.geojson \
--data-map path/to/data_map.json \
--graph path/to/adjacency_graph.json \
--plans path/to/plans.jsonl \
--scores path/to/scores.csv \
--by-district path/to/by-district.jsonl
```

where:

*   The state is a two-character state code.
*   The `plan-type` is `congress`, 'upper`, or `lower`, for upper and lower state house.
*   The `geojson` is a [Dave's Redistricting](https://davesredistricting.org/) (DRA) precinct GeoJSON file with data coded by dataset.
    An example is provided in `testdata/data/NC_vtd_datasets.geojson`.
*   The `data-map` is a JSON file that maps how to extract data from the GeoJSON.
    An example is provided in `testdata/data/NC_data_map.json`.
*   The `graph` is a JSON file that contains the node/list of neighbors adjacency graph of the precincts.
    An example is provided in `testdata/intermediate/NC_graph.json`.
*   The `plans` is a JSONL file that contains the ensemble of plans to be scored.
    The plans can be simple dictionaries of geoid:district assignments, or
    they can be tagged 'plan' records in the ensemble format used by `rdatools/rdatools` and `rdatools/rdautils`.
    An example of the latter is provided in `testdata/ensemble/NC_congress_plans.100.jsonl`.

The script writes a set of plan-level scores to a CSV file
a set of by-district measures to a JSONL file, and 
metadata for the scores in a JSON file.
Examples of these files can be found in `testdata/scoring/`.

The plan-level scores are described in [Scores (Metrics)]({{ '/scores' | prepend: site.baseurl }}).

NOTE: This scripts does *not* extract an adjacency graph from the GeoJSON.
It uses a pre-computed adjacency graph from DRA.

By default, this script calculates all metrics ("scores") for all plans in an input ensemble.
If your ensembles are very large though, you can [increase scoring throughput]({{ '/throughput' | prepend: site.baseurl }}),
by breaking the overall process down into pieces and running them in parallel.

## Component Scripts

If you want more fine-grained control over the scoring process,
you can use these component scripts directly.

### Extracting an Adjacency Graph from a GeoJSON

This script extracts an adjacency graph from a DRA GeoJSON file.

```bash
scripts/extract_graph.py \
--geojson path/to/DRA.geojson \
--graph path/to/adjacency_graph.json
```

NOTE: This script can read a CSV file that contains more precinct-to-precinct adjacencies to add to the graph.

### Extracting Data from a DRA GeoJSON

This script extracts data from a DRA GeoJSON file and writes it to a JSONL file,
using the data map to determine what data to extract.

```bash
scripts/extract_data.py \
--geojson path/to/DRA.geojson \
--data-map path/to/data_map.json \
--graph path/to/adjacency_graph.json \
--data path/to/input_data.jsonl
```

### Aggregating Plans by District

This script reads a stream of plans from STDIN, aggregates data & shapes by district,
and writes the plan and the aggregates to STDOUT.

```bash
cat path/to/plans.jsonl \
| scripts/aggregate.py \
--state xx \
--plan-type congress \
--data path/to/input_data.jsonl \
--graph path/to/adjacency_graph.json > path/to/plans_plus_aggregates.jsonl
```
The script also passes an optional metadata record through to STDOUT.

### Scoring Plans

This script reads a stream of plans with district aggregates from STDIN,
scores the plans, and writes the plan-level scores to STDOUT along with
the district-level aggregates.

```bash
cat path/to/plans_plus_aggregates.jsonl \
| scripts/score.py \
--state xx \
--plan-type congress \
--data path/to/input_data.jsonl \
--graph path/to/adjacency_graph.json > path/to/scores_plus_aggregates.jsonl
```

### Write Scores to Disk

This script reads a stream of scores with district aggregates from STDIN,
and writes the plan-level scores to a CSV file and the district-level aggregates to a JSONL file.

```bash
cat path/to/scores_plus_aggregates.jsonl \
| scripts/write.py \
--data path/to/input_data.jsonl \
--scores path/to/scores.csv \
--by-district path/to/by-district.jsonl
```
